using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace supermarket
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.Write("Введите длинну очереди: ");
            Supermarket cashbox = new Supermarket(GetLengthOfTurn());
            cashbox.BuyProduct();
        }

        static int GetLengthOfTurn()
        {
            int lengthOfTurn = 0;
            bool resultConvert = false;
            while (resultConvert == false)
            {
                resultConvert = int.TryParse(Console.ReadLine(), out lengthOfTurn);
                if (resultConvert == false)
                {
                    Console.WriteLine("Вы ввели не коректное значенеи!\nПоробуйте еще раз.");
                }
            }
            return lengthOfTurn;
        }
    }

    class Supermarket
    {
        private Queue<Buyer> _buers = new Queue<Buyer>();
        private int _cashOfCheckout;

        public Supermarket(int longTurn)
        {
            for (int i = 0; i < longTurn; i++)
            {
                _buers.Enqueue(new Buyer());
            }
            _cashOfCheckout = 0;
        }

        public void BuyProduct()
        {
            bool isOpen = true;
            int countBuer = 0, sumProducts, cashBuer;
            Buyer buyer = _buers.Peek();
            while (isOpen == true)
            {
                cashBuer = buyer.Cash;
                Console.WriteLine($"Сумма в кассе: {_cashOfCheckout}.\nПокупатель № {++countBuer}. В кошельке: {cashBuer}.");
                sumProducts = buyer.GetSumProducts();
                while (sumProducts <= cashBuer)
                {
                    buyer.RemoveProduct();
                    sumProducts = buyer.GetSumProducts();
                }
                _cashOfCheckout += cashBuer - sumProducts;
                _buers.Dequeue();
                Console.WriteLine("\nСледующий покупатель.");
                if (_buers.Count == 0)
                {
                    Console.WriteLine("Очередь закончилась.");
                    isOpen = false;
                }
            }
        }
    }

    class Buyer
    {
        public int Cash { get; private set; }

        private static Random _random = new Random();
        private List<Product> _products = new List<Product>();

        public Buyer()
        {
            int quantityProsucts = _random.Next(1, 9);
            for (int i = 0; i < quantityProsucts; i++)
            {
                _products.Add(new Product());
            }
            Cash = _random.Next(100, 2000);
        }

        public int GetSumProducts()
        {
            int sumProducts = 0;
            foreach (Product cost in _products)
            {
                sumProducts += cost.Cost;
            }
            Console.WriteLine("Сумма всех продуктов в карзине: " + sumProducts);
            return sumProducts;
        }

        public void RemoveProduct()
        {
            Console.WriteLine("У покупателя не достаточно средств, выкладываем один из товаров.");
            int indexProduct = _random.Next(0, _products.Count - 1);
            _products.RemoveAt(indexProduct);
        }
    }

    class Product
    {
        public int Cost { get; private set; }

        private static Random _random = new Random();

        public Product()
        {
            Cost = _random.Next(1, 667);
        }
    }
}
