using System;
using System.Collections.Generic;

namespace GladiatorialArena
{
    class Program
    {
        static void Main(string[] args)
        {
            Random random = new Random();
            Arena arena = new Arena(true);
            arena.ChoiseGladiatorials(random);
        }
    }

    class Arena
    {
        private List<Warrior> _warriors = new List<Warrior>();
        private bool _isOpen;
        
        public Arena(bool isOpenArena)
        {
            _warriors.Add(new Barbarian(50, 10, 10));
            _warriors.Add(new Warloсk(100, 5, 20, 100));
            _warriors.Add(new Knight(100, 8, 50));
            _warriors.Add(new Archer(100, 12, 15));
            _warriors.Add(new Witcher(100, 10, 30));
            _isOpen = isOpenArena;
        }

        public void ChoiseGladiatorials(Random random)
        {
            string userInput = "";
            int warriorOneChoice = 0;
            int warriorTwoChoise = 0;

            if (_warriors.Count == 0)
            {
                Console.WriteLine("В темнице нету войнов.");
                _isOpen = false;
            }
            while (_isOpen == true)
            {
                for (int i = 0; i < _warriors.Count; i++)
                {
                    _warriors[i].ShowClassName(i);
                }
                Console.WriteLine("\nВыберите бойца #1: ");
                warriorOneChoice = GetIndex(_warriors.Count);
                Console.WriteLine("Выберите бойца #2: ");
                warriorTwoChoise = GetIndex(_warriors.Count, warriorOneChoice);
                Fight(_warriors[warriorOneChoice - 1], _warriors[warriorTwoChoise - 1], random);
                Console.Write("\nЕсли хотите закрыть арену введите yes: ");
                userInput = Console.ReadLine();
                if (userInput == "yes")
                {
                    _isOpen = false;
                }
            }
        }

        private int GetIndex(int countWarriors, int warriorCheck = 0)
        {
            int userInput = 0;
            bool resultTryConvert = true;

            while (resultTryConvert == true)
            {
                bool resultConvert = int.TryParse(Console.ReadLine(), out userInput);
                if (userInput <= 0 || userInput > countWarriors)
                {
                    Console.WriteLine("Такого бойца нету. Выберите другова.");
                    continue;
                }
                else if (userInput == warriorCheck)
                {
                    Console.WriteLine("Этот боец уже выбран. Выберите другова.");
                    continue;
                }
                resultTryConvert = resultConvert ? false : true;
                if (resultTryConvert)
                    Console.WriteLine("Вы ввели не коректные данные. Попробуйте еще раз.");
            }
            return userInput;
        }

        private void Fight(Warrior oneWarrior, Warrior twoWarrior, Random random)
        {
            string classNameWarriorOne = oneWarrior.ClassName;
            string classNameWarriorTwo = twoWarrior.ClassName;
            float healthWarriorOne = oneWarrior.Health;
            float healthWarriorTwo = twoWarrior.Health;
            int warriorOneAction, warriorTwoAction, rounds = 0, countStunning = 0;

            Console.WriteLine($"На арене сражаются: \n{classNameWarriorOne} VS {classNameWarriorTwo}\n\n");
            while (healthWarriorOne > 0 && healthWarriorTwo > 0)
            {
                RestorationOfAbilities(oneWarrior);
                RestorationOfAbilities(twoWarrior);
                warriorOneAction = ChoiseOfAction(random);
                warriorTwoAction = ChoiseOfAction(random);
                MoveBattleCourse(oneWarrior, twoWarrior, ref warriorOneAction, warriorTwoAction, classNameWarriorOne, ref countStunning, random);
                MoveBattleCourse(twoWarrior, oneWarrior, ref warriorTwoAction, warriorOneAction, classNameWarriorTwo, ref countStunning, random);
                oneWarrior.ShowInfo();
                twoWarrior.ShowInfo();
                if (countStunning > 0)
                {
                    countStunning--;
                    Console.WriteLine($"{countStunning}");
                }
                else
                {
                    if (oneWarrior.Status == false || twoWarrior.Status == false)
                    {
                        oneWarrior.ChengeStatus(true);
                        twoWarrior.ChengeStatus(true);
                    }
                }
                Console.WriteLine($"------------Раунд: {++rounds}------------\n");
            }
            Console.Write("Бой окончен. ");
            if (healthWarriorOne >= 0 && healthWarriorTwo >= 0)
            {
                Console.Write("Ничья. Оба бойца погибли.");
            }
            else
            {
                string resultFight = healthWarriorOne >= 0 ? $"{classNameWarriorOne}" : $"{classNameWarriorTwo}";
                Console.WriteLine($"Победил: {resultFight}");
            }
        }

        private int ChoiseOfAction(Random random)
        {
            return random.Next(0, 3);
        }

        private void AttacWarrior(float action, Warrior choiceWarrior)
        {
            choiceWarrior.Attac(action);
        }

        private void MoveWarriorInfo(int wariorAction, string choiceWarrior)
        {
            if (wariorAction == 0)
            {
                Console.WriteLine($"Боец {choiceWarrior} защищаеться");
            }
            else if (wariorAction == 1)
            {
                Console.WriteLine($"Боец {choiceWarrior} атакует");
            }
            else if (wariorAction == 2)
            {
                Console.WriteLine($"Боец {choiceWarrior} применяет спец атаку");
            }
        }

        private void MoveBattleCourse(Warrior choiceWarrior, Warrior enemyWarrior, ref int choiceWarriorAction, int enemyWarriorAction, string classNameWarrior, ref int countStunning, Random random)
        {
            if (choiceWarrior.Status)
            {
                MoveWarriorInfo(choiceWarriorAction, classNameWarrior);
                MoveWarrior(choiceWarrior, enemyWarrior, enemyWarriorAction, choiceWarriorAction, ref countStunning, random);
            }
            else
            {
                Console.WriteLine($"{classNameWarrior} оглушен.");
                choiceWarriorAction = 1;
            }
        }

        private void MoveWarrior(Warrior choiceWarrior, Warrior enemyWarrior, int enemyWarriorAction, int choiceWarriorAction, ref int countStunning, Random random)
        {
            if (enemyWarriorAction == 2)
            {
                enemyWarriorAction--;
            }
            int moveWarriors = enemyWarriorAction * choiceWarriorAction;
            float action;
            switch (choiceWarrior)
            {
                case Barbarian barbarian:
                    action = choiceWarriorAction == 2 ? barbarian.AttackSwipe() : barbarian.Damage * moveWarriors;
                    AttacWarrior(action, enemyWarrior);
                    break;
                case Warloсk warlock:
                    action = choiceWarriorAction == 2 ? warlock.AttackBallOfDarkness() * enemyWarriorAction : warlock.Damage * moveWarriors;
                    AttacWarrior(action, enemyWarrior);
                    break;
                case Knight knight:
                    action = choiceWarriorAction == 2 ? knight.AttackCounter() * enemyWarriorAction : knight.Damage * moveWarriors;
                    AttacWarrior(action, enemyWarrior);
                    break;
                case Archer archer:
                    action = choiceWarriorAction == 2 ? archer.ShotArrows(enemyWarrior, ref countStunning, random.Next(1,5)) * enemyWarriorAction : archer.Damage * moveWarriors;
                    AttacWarrior(action, enemyWarrior);
                    break;
                case Witcher witcher:
                    action = choiceWarriorAction == 2 ? witcher.ChoicePotion(random.Next(1, 4)) * enemyWarriorAction : witcher.Damage * moveWarriors;
                    AttacWarrior(action, enemyWarrior);
                    break;
            }
        }

        private void RestorationOfAbilities(Warrior warrior)
        {
            switch (warrior)
            {
                case Warloсk warlock:
                    warlock.ReplenishmentOfMana();
                    break;
                case Witcher witcher:
                    witcher.RecoveryPotions();
                    break;
                case Knight knight:
                    knight.SaveHealth();
                    break;
            }
        }
    }

    abstract class Warrior
    {
        public string ClassName { get; protected set; }
        public float Health { get; protected set; }
        public float Damage { get; protected set; }
        public bool Status { get; protected set; }
        protected float Armor;

        public void Attac(float damageEnemay)
        {
            Health -= damageEnemay / 100 * Armor;
        }

        public void ShowClassName(int classNumber)
        {
            Console.WriteLine($"{classNumber + 1}.{ClassName}");
        }

        public void ShowInfo()
        {
            Console.WriteLine($"Класс: {ClassName}\n" +
                $"Здоровье: {Health}\n" +
                $"Урон: {Damage}\n" +
                $"Броня: {Armor}\n");
        }

        public void ChengeStatus(bool statusWArrior)
        {
            Status = statusWArrior;
        }
    }

    class Barbarian : Warrior
    {
        public Barbarian(float health, float damage, float armor)
        {
            ClassName = "Варвар";
            Health = health;
            Damage = damage;
            Armor = armor;
            Status = true;
        }

        public float AttackSwipe()
        {
            return Damage * 2;
        }
    }

    class Warloсk : Warrior
    {
        private int _mana;
        public Warloсk(float health, float damage, float armor, int mana)
        {
            ClassName = "Чернокнижник";
            Health = health;
            Damage = damage;
            Armor = armor;
            _mana = mana;
            Status = true;
        }

        public float AttackBallOfDarkness()
        {
            if (_mana < 50)
            {
                Console.WriteLine("Не достаточно маны.");
                return 0;
            }
            else
            {
                _mana -= 50;
                return Damage * 4;
            }
        }

        public void ReplenishmentOfMana()
        {
            if (_mana != 100)
            {
                _mana += 10;
            }
        }
    }

    class Knight : Warrior
    {
        static private float _healthSave;
        public Knight(float health, float damage, float armor)
        {
            ClassName = "Рыцарь";
            Health = health;
            Damage = damage;
            Armor = armor;
            Status = true;
        }

        public void SaveHealth()
        {
            _healthSave = Health;
        }

        public float AttackCounter()
        {
            Health = _healthSave;
            return Damage * 2;
        }
    }

    class Archer : Warrior
    {
        public Archer(float health, float damage, float armor)
        {
            ClassName = "Лучник";
            Health = health;
            Damage = damage;
            Armor = armor;
            Status = true;
        }

        public float ShotArrows(Warrior enemyWarrior, ref int countStunning, int arrows)
        {
            ChangeArrowStatus(enemyWarrior, ref countStunning);
            return Damage * arrows;
        }

        private void ChangeArrowStatus(Warrior enemyWarrior, ref int countStunning)
        {
            bool statusChange = enemyWarrior.Status == true ? false : true;
            int moves = 3;
            enemyWarrior.ChengeStatus(statusChange);
            if (enemyWarrior.Status == false)
            {
                countStunning += moves;
            }
            Console.WriteLine($"{enemyWarrior.ClassName} оглушен на {moves} хода");
        }
    }

    class Witcher : Warrior
    {
        public int CountPotions { get; private set; }
        public int NumberPotion { get; private set; }
        public Witcher(float health, float damage, float armor)
        {
            ClassName = "Ведьмак";
            Health = health;
            Damage = damage;
            Armor = armor;
            Status = true;
            CountPotions = 0;
            NumberPotion = 0;
        }

        public float ChoicePotion(int numberPotion)
        {
            int rollbackMove = 5;
            int armorPoints = 15;
            int healthPoints = 5;
            int damagePoints = 2;
            if (CountPotions <= 0)
            {
                switch (numberPotion)
                {
                    case 1:
                        DrinkPotionHealth();
                        Console.WriteLine($"Зелье действует {rollbackMove + 1} ходов. За каждый ход востанавливает {healthPoints} едениц здоровья.");
                        break;
                    case 2:
                        DrinkPotionDamage();
                        Console.WriteLine($"Зелье действует {rollbackMove + 1} ходов. Каждый ход атака увеличиваеться на {damagePoints}.");
                        break;
                    case 3:
                        DrinkPotionArmor();
                        Console.WriteLine($"Зелье добовляет {healthPoints} едениц защите.");
                        break;
                    default:
                        Console.WriteLine("Зелье не применяеться.");
                        break;
                }
                Console.WriteLine($"Зелье можно выпить через {rollbackMove + 1} ходов.");
                CountPotions = rollbackMove;
                NumberPotion = numberPotion;
            }
            else
            {
                Console.WriteLine("Вы не можете выпить два зелья за раз.");
            }
            return Damage;
        }

        public void RecoveryPotions()
        {
            if (CountPotions > 0)
            {
                CountPotions--;
                switch (NumberPotion)
                {
                    case 1:
                        DrinkPotionHealth();
                        break;
                    case 2:
                        DrinkPotionDamage();
                        break;
                }
            }
        }

        private void DrinkPotionDamage()
        {
            int raisingDamage = 2;
            Damage += raisingDamage;
            Console.WriteLine($"Повышение атаки на {raisingDamage}.");
        }

        private void DrinkPotionHealth()
        {
            int raisingHealth = 5;
            if (Health < 100)
            {
                Health += raisingHealth;
                Console.WriteLine($"Излечивает на {raisingHealth} едениц.");
            }
            else
            {
                Console.WriteLine("Здоровье полное.");
            }
        }

        private void DrinkPotionArmor()
        {
            int raisinfArmor = 15;
            Armor += raisinfArmor;
            Console.WriteLine($"Повышает защиту на {raisinfArmor} едениц.");
        }
    }
}
